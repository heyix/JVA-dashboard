<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
    <link rel="styleSheet" href="/static/css/main.css" />
  </head>

  <body>
    <div class="video-container">
      <video id="myVideo" preload="auto" controls>
        <source
          src="https://www.dropbox.com/s/q2p6682a1n9o8xq/3min-JVA-video.mp4?raw=1"
          type="video/mp4"
        />
      </video>
    </div>
    <div id="transcriptContainer">
      <div id="transcriptText" class="clickable"></div>
    </div>
    <div id="commentContainer">
      <div id="makeCommentBox">
        <h4>Comments:</h4>
        <textarea
          class="makeComment"
          cols="30"
          rows="2"
          oninput="auto_grow(this)"
          placeholder="Select a sentence and type your comment here."
        ></textarea>
        <br />
        <button id="add-comment">Add!</button>
      </div>
      <br />
      <div id="commentBox"></div>
    </div>
    <br />
    <div id="eye-gaze">
      <h1>Eye-gaze Analysis</h1>
      <p>A: <span id="eye-A">0</span></p>
      <p>B: <span id="eye-B">0</span></p>
    </div>

    <script src="/static/js/jquery.js"></script>
    <script src="/static/js/main.js"></script>
    <script>
      //get data from Django
      //csv:the csv file about eye-gaze data
      //data:a Json data generated by parsing google speech to text API, work here as a dict
        var csv = {{data_read | safe}};
        var data = {{data | safe}};
        sentences = data["results"];
        //Mark the last selected text as global variable
        var range;
        //Disable the button by default
        var commentButton=$("#add-comment");
        commentButton.prop("disabled",true);
        var textId=0;
        var target;


        transcriptDiv = document.querySelector("#transcriptText");
        video = document.querySelector("#myVideo");
        display(transcriptDiv, video, sentences);


        //Click on the transcript
        $('.clickable').click(function (e) {
            var sel = window.getSelection();
            var getString = sel.toString();
            var eyeA = document.getElementById("eye-A");
            var eyeB = document.getElementById("eye-B");


            e.stopPropagation();
            //If this is true, the action is just click on the transcript, just return
            //If this is false, the action is highlingting a transcript, keep going
            if (getString == "" || getString.length == 1) return;
            //If this is highlingting, update the last selected text
            range=sel.getRangeAt(0);
            //active the button for making comment
            commentButton.prop("disabled",false);
            //detect highlight
            var startIndex = 0;
            var startStr;
            //Anchor Id is the id of the first word of highlighting text, extentId is the last id
            var anchorId = parseInt(sel.anchorNode.parentElement.id);
            var extentId = parseInt(sel.extentNode.parentElement.id);
            //When selecting from previous to later and later to previous, the two id should be reversed
            if ((sel.focusNode.nodeValue == null) || (anchorId == extentId && sel.anchorOffset <= sel
                    .focusOffset) || (anchorId < extentId)) {
                startStr = selectFirst(getString, sel.anchorNode.nodeValue, sel.anchorOffset);
                startIndex = anchorId;
            } else {
                startStr = selectFirst(getString, sel.focusNode.nodeValue, sel.focusOffset);
                startIndex = extentId;
            }
            //Get the start time by finding the begin time of first selected word
            var startWords = sentences[startIndex]["alternatives"][0]["words"];
            var startTime = getStartTime(startWords, startStr);
            //set the video time
            video.currentTime = startTime;
            video.play();

            //endString
            var endString;
            var endIndex;
            //finding the last word, also different order of selection should reverse the id
            if ((sel.focusNode.nodeValue != null) && ((anchorId == extentId && sel.anchorOffset <= sel
                    .focusOffset) || (anchorId < extentId))) {
                endString = selectLast(getString, sel.focusNode.nodeValue, sel.focusOffset)
                endIndex = extentId;
            } else {
                endString = selectLast(getString, sel.anchorNode.nodeValue, sel.anchorOffset);
                endIndex = anchorId;
            }

            //eye-gaze
            var endWords = sentences[endIndex]["alternatives"][0]["words"];
            var endTime = getEndTime(endWords, sel.focusNode.nodeValue, endString);


            startTime = parseInt(startTime) + 1;
            var gap;
            var totalA = 0.0;
            var totalB = 0.0;
            //calculating the total A and R between start time and end time, then calculuate the average
            if (startTime == endTime) {
                totalA = parseFloat(csv[startTime][1]);
                totalB = parseFloat(csv[startTime][2]);
                gap = 1;
            } else {
                for (var i = startTime; i < endTime; i++) {
                    totalA += parseFloat(csv[i][1]);
                    totalB += parseFloat(csv[i][2]);
                }
                gap = endTime - startTime;
            }
            eyeA.innerHTML = totalA / gap;
            eyeB.innerHTML = totalB / gap;
      });





      //Highlighting text and make comment
      commentButton.click(function(){
        //If the user doesn't type anything, ignore it
        if($(".makeComment").val()=="")return;
        //disable the button after submit
        commentButton.prop("disabled",true);
        //highlight the selected text
        var highlightText=highlightSelection(range,textId);
        var comment=$(".makeComment").val();

        //send ajax message to Django to update the database
        $.ajax({
          url:"/comment/talkData/",
          type:"post",
          indexValue:textId,
          data:{
            highlightText:highlightText,
            comment:comment,
            lineNumber:parseInt(range.endContainer.id),
          },
          //When the database is updated, we need to create new comment box and bind listener to it
          success:function(response,indexValue){
            //create new comment box
            var newComment=document.createElement("textarea");
            newComment.setAttribute("class","comment");
            newComment.setAttribute("id","comment"+this.indexValue);
            newComment.textContent="Time:"+response.time+"\r\n"+comment;
            $("#commentBox").append(newComment);

            //Bind event listener to the highlighted text inorder to move the box when clicked
            var coComment=$('#'+'comment'+parseInt(this.indexValue));
            //When click on highlighted text, move left
            $("#text"+this.indexValue).click(function(e){moveLeft(coComment,this.indexValue)});
            document.removeEventListener('click',moveBack)
            //When click on other place, move back position
            document.addEventListener('click',(event)=>moveBack(coComment,event));
            auto_grow(document.getElementById("comment"+this.indexValue));
          }
        })
        textId++;

      });
    </script>
  </body>
</html>
